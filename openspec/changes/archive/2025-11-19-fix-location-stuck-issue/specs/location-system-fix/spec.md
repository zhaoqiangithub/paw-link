# 定位系统修复规格

## ADDED Requirements

### Requirement: 定位流程必须在20秒内完成或显示明确错误
定位流程 SHALL 在20秒内完成定位或显示明确的错误信息。如果20秒内无法获取位置，MUST向用户显示明确的错误信息，包括错误原因和解决建议。

#### Scenario: 定位成功
- **WHEN** 用户打开应用，授权定位权限
- **THEN** 应用在15-20秒内获取位置，显示用户位置和地址

#### Scenario: 定位超时
- **WHEN** GPS信号弱或网络问题导致无法获取位置
- **THEN** 应用在20秒后显示超时错误信息，不再显示"正在获取位置"

**覆盖范围**：
- 组件：`components/NativeMapView.tsx`
- Hook：`hooks/use-location.ts`
- 页面：`app/(tabs)/index.tsx`

**验收标准**：
- 定位开始后20秒内一定完成或超时
- 超时后显示错误信息，不再显示"正在获取位置"
- 用户可以点击重试按钮重新尝试

**监控指标**：
- 定位完成时间（目标：≤20秒）
- 超时率（目标：<5%在正常网络环境下）

---

### Requirement: 实现智能重试机制，最多3次重试
对于可恢复的定位错误（超时、网络错误），系统 SHALL 自动重试最多3次，采用指数退避策略（1秒、2秒、3秒延迟）。对于不可恢复的错误（权限拒绝、GPS不可用），MUST立即停止并提示用户。

#### Scenario: 网络错误自动重试
- **WHEN** 网络问题导致地址解析失败，但GPS定位成功
- **THEN** 系统自动重试最多3次，每次延迟逐渐增加

#### Scenario: 权限拒绝不重试
- **WHEN** 用户拒绝了定位权限
- **THEN** 系统立即停止重试，显示权限引导信息

**覆盖范围**：
- 组件：`components/NativeMapView.tsx`

**验收标准**：
- 可重试错误自动重试1-3次
- 每次重试间隔逐渐增加（1s, 2s, 3s）
- 权限拒绝错误不重试，直接提示
- 重试失败后提供明确反馈和重试选项

**重试错误类型**：
- ✅ 可重试：TIMEOUT, NETWORK_ERROR, POSITION_UNAVAILABLE
- ❌ 不可重试：PERMISSION_DENIED, API_UNAVAILABLE

---

### Requirement: 统一位置状态管理，消除冲突
应用 SHALL 只使用单一的定位逻辑入口（NativeMapView内部定位），避免多个定位源竞争导致的状态混乱。所有位置相关功能都 SHALL 从统一的位置状态获取位置信息。

#### Scenario: 单一定位入口
- **WHEN** 应用启动定位
- **THEN** 只有NativeMapView组件处理定位逻辑，其他组件通过props或context获取位置

#### Scenario: 状态无冲突
- **WHEN** 定位过程中
- **THEN** 不会有多个定位源同时运行，避免状态混乱

**覆盖范围**：
- 组件：`components/NativeMapView.tsx`
- Hook：`hooks/use-location.ts`

**验收标准**：
- 地图定位由NativeMapView统一管理
- 其他组件通过props或context获取位置信息
- 同一时间只有一个定位流程在运行
- 状态转换清晰，无竞态条件

---

## MODIFIED Requirements

### Requirement: 改善错误处理和用户反馈
应用 SHALL 提供更清晰、更具体的错误信息和建议，帮助用户理解问题和解决方法。错误信息 MUST 包含错误原因、解决建议和可操作的下一步。

#### Scenario: 权限被拒绝
- **WHEN** 用户拒绝了定位权限
- **THEN** 显示"⚠️ 定位权限被拒绝，请在设置中开启定位权限"，并提供"去设置"按钮

#### Scenario: GPS不可用
- **WHEN** 设备GPS不可用（如模拟器）
- **THEN** 显示"⚠️ 此设备GPS不可用，请使用真机或手动选择位置"

**修改内容**：
- 增强错误分类：区分权限、网络、GPS等不同错误
- 优化错误文本：使用中文友好提示
- 添加解决建议：针对每种错误提供具体的解决步骤
- 改善重试体验：提供清晰的重试按钮和状态指示

**覆盖范围**：
- 组件：`components/NativeMapView.tsx`
- 页面：`app/(tabs)/index.tsx`

**验收标准**：
- 错误信息具体且有帮助性
- 用户能根据错误信息采取正确行动
- 重试按钮醒目且功能正常

**错误处理改进示例**：
```
旧：定位失败
新：⚠️ 定位超时，请检查GPS设置或网络后重试
     [重试定位]  [手动选择位置]
```

---

### Requirement: 优化状态转换逻辑，确保loading状态正确重置
应用 SHALL 确保在所有路径（成功、失败、超时、权限拒绝）下loading状态都能正确重置为false。应用 MUST 不会卡在"正在定位"状态。

#### Scenario: 定位成功状态转换
- **WHEN** 定位成功获取位置和地址
- **THEN** loading状态变为false，显示位置信息和地址

#### Scenario: 定位失败状态转换
- **WHEN** 定位过程中发生错误
- **THEN** loading状态立即变为false，显示错误信息和重试选项

**修改内容**：
- 在所有异常处理路径中设置 `setLoading(false)`
- 确保状态机转换正确：IDLE → REQUESTING → GETTING_LOCATION → SUCCESS/ERROR
- 添加详细的状态转换日志

**覆盖范围**：
- 组件：`components/NativeMapView.tsx`

**验收标准**：
- 无论成功还是失败，定位完成后loading都变为false
- 用户能看到正确的状态指示（定位中/成功/失败）
- 应用不会卡在"正在定位"状态

---

## REMOVED Requirements

### Requirement: 移除可能导致冲突的重复定位逻辑
应用 SHALL 移除或废弃与地图定位冲突的重复代码，确保定位逻辑清晰、单一。useLocation hook SHALL 仅在必要场景使用，不与NativeMapView定位逻辑冲突。

#### Scenario: 移除重复定位代码
- **WHEN** 代码审查
- **THEN** 确认无重复的定位逻辑，定位职责清晰分离

#### Scenario: 状态管理统一
- **WHEN** 定位流程执行
- **THEN** 只有单一的位置状态源，无状态冲突

**移除内容**：
- 移除 `app/(tabs)/index.tsx` 中与 `useLocation` 的冲突使用
- 移除 `use-location.ts` 中与地图定位重复的功能
- 清理无用的定位相关代码和状态

**覆盖范围**：
- 页面：`app/(tabs)/index.tsx`
- Hook：`hooks/use-location.ts`

**验收标准**：
- 代码中无重复的定位逻辑
- 定位职责清晰，无混淆
- 无未使用的导入或变量

---

## Scenario 详细说明

### Scenario 1: 用户首次打开应用
**触发条件**：用户启动应用，进入首页

**期望行为**：
1. 应用请求定位权限
2. 用户同意后开始定位
3. 15-20秒内显示位置或错误
4. 如果成功，显示用户位置和地址
5. 如果失败，显示错误信息和重试按钮

**验收**：
- ✅ 20秒内完成或显示错误
- ✅ 状态指示清晰
- ✅ 可点击重试

### Scenario 2: 用户拒绝定位权限
**触发条件**：首次打开应用时用户拒绝定位权限

**期望行为**：
1. 应用显示权限请求
2. 用户点击"拒绝"
3. 应用显示明确的权限引导信息
4. 提供"去设置"或"手动选择位置"选项

**验收**：
- ✅ 不自动重试
- ✅ 提供清晰的权限引导
- ✅ 有备选方案（手动选择）

### Scenario 3: GPS信号弱导致超时
**触发条件**：用户在室内或GPS信号弱的环境

**期望行为**：
1. 开始定位
2. 20秒后超时
3. 显示超时错误信息
4. 提供"重试"和"手动选择位置"选项
5. 用户点击重试，重新尝试定位

**验收**：
- ✅ 20秒后一定超时
- ✅ 错误信息准确
- ✅ 重试机制有效
- ✅ 有手动选择备选

### Scenario 4: 网络问题导致地址解析失败
**触发条件**：用户网络不稳定或离线

**期望行为**：
1. GPS定位成功获取坐标
2. 地址解析（Amap API）失败
3. 显示位置坐标，但提示地址获取失败
4. 可以继续使用基本定位功能

**验收**：
- ✅ 能获取GPS坐标
- ✅ 地址失败时有提示
- ✅ 基本功能仍可用

### Scenario 5: 用户手动选择位置
**触发条件**：自动定位失败或用户选择手动选择

**期望行为**：
1. 用户点击"手动选择位置"
2. 地图进入选择模式
3. 用户点击地图选择位置
4. 应用使用用户选择的位置
5. 提供"返回自动定位"选项

**验收**：
- ✅ 手动选择功能正常
- ✅ 选择的位置可用
- ✅ 可返回自动定位模式

---

## 兼容性说明

### 向后兼容
- ✅ 保持现有UI布局不变
- ✅ 保持现有API接口不变
- ✅ 仅改善用户体验和稳定性
- ✅ 不影响iOS平台功能

### 平台支持
- ✅ Android：主要修复目标
- ✅ iOS：确保无回归问题
- ✅ Web：保持现有行为（Web端不支持原生定位）

---

## 测试计划

### 单元测试
- 定位流程状态转换测试
- 超时控制测试
- 重试机制测试
- 错误分类测试

### 集成测试
- 完整定位流程测试
- 权限处理测试
- 错误恢复测试
- UI交互测试

### 真机测试
- Android多设备测试
- 不同网络环境测试
- 不同GPS信号环境测试
- 长时间使用稳定性测试

---

## 验收检查清单

在完成修复后，必须满足以下所有条件：

**功能性验收**：
- [ ] 20秒内完成定位或显示错误（Android）
- [ ] 权限拒绝场景处理正确
- [ ] 重试机制有效（最多3次）
- [ ] 所有状态转换正确
- [ ] 手动选择位置功能正常
- [ ] 无卡死现象

**代码质量验收**：
- [ ] 无TypeScript编译错误
- [ ] ESLint检查通过
- [ ] 代码注释充分
- [ ] 无重复代码

**用户体验验收**：
- [ ] 错误信息清晰有用
- [ ] 重试操作简单
- [ ] 状态反馈及时
- [ ] 提供备选方案

**测试验收**：
- [ ] 所有测试用例通过
- [ ] Android真机测试通过
- [ ] iOS无回归问题
- [ ] 边界情况测试通过
