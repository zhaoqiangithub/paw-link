# 定位卡住问题修复任务列表

## 任务概览

**目标**：彻底解决安卓设备上定位功能卡住、无法完成定位的问题

**验收标准**：
- ✅ 安卓设备上15-20秒内完成定位或显示明确错误
- ✅ 重试机制有效，最多3次重试
- ✅ 权限拒绝场景有清晰引导
- ✅ 所有状态正确更新，无卡住现象
- ✅ 提供手动选择位置备选方案

---

## 阶段1：问题分析和准备

### [ ] 任务1：分析现有定位相关代码
**优先级**：P0 (必须)
**预估时间**：1小时
**描述**：全面分析定位相关的所有代码文件，理解当前实现和问题点

**详细任务**：
- 读取并分析 `hooks/use-location.ts`
- 读取并分析 `components/NativeMapView.tsx`
- 读取并分析 `app/(tabs)/index.tsx`
- 搜索所有使用 `useLocation` 的地方
- 记录当前定位流程和潜在问题点

**验证标准**：
- ✅ 列出所有定位相关文件
- ✅ 理解当前状态转换逻辑
- ✅ 识别可能的竞态条件

**输出**：问题分析报告（markdown）

---

### [ ] 任务2：检查权限配置
**优先级**：P0 (必须)
**预估时间**：30分钟
**描述**：验证应用权限配置是否正确

**详细任务**：
- 检查 `app.json` 中的Android权限配置
- 检查 iOS 的 infoPlist 配置
- 确认权限描述文本是否清晰
- 对比文档中的推荐配置

**验证标准**：
- ✅ Android有 ACCESS_COARSE_LOCATION 和 ACCESS_FINE_LOCATION
- ✅ iOS 有定位权限描述
- ✅ 权限描述中文友好

---

## 阶段2：重构定位系统

### [ ] 任务3：优化NativeMapView定位流程
**优先级**：P0 (必须)
**预估时间**：2小时
**描述**：重构地图组件的定位逻辑，确保状态管理正确

**详细任务**：
- 移除可能与useLocation冲突的代码
- 实现完整的状态机（IDLE → REQUESTING → GETTING_LOCATION → SUCCESS/ERROR）
- 确保所有退出点都正确设置 `setLoading(false)`
- 添加详细的控制台日志用于调试
- 优化错误类型识别和分类

**代码改进点**：
```typescript
// 确保所有路径都设置loading = false
try {
  setLoading(true);
  // ... 定位逻辑
} catch (error) {
  setLoading(false); // 错误时也要设置
  throw error;
}
```

**验证标准**：
- ✅ 状态转换正确，无卡死
- ✅ 所有错误路径都正确处理
- ✅ 日志输出清晰，便于调试

---

### [ ] 任务4：实现智能重试机制
**优先级**：P0 (必须)
**预估时间**：1小时
**描述**：实现最多3次的智能重试，区分可重试和不可重试错误

**详细任务**：
- 实现指数退避重试（1s, 2s, 3s）
- 区分错误类型：
  - 可重试：TIMEOUT, NETWORK_ERROR
  - 不可重试：PERMISSION_DENIED, API_UNAVAILABLE
- 重试时清理之前的状态
- 达到最大重试次数后提供明确反馈

**验证标准**：
- ✅ 可重试错误自动重试最多3次
- ✅ 不可重试错误立即失败并给出建议
- ✅ 每次重试都有延迟，避免频繁请求

---

### [ ] 任务5：强化超时控制
**优先级**：P0 (必须)
**预估时间**：1小时
**描述**：实现严格超时控制，避免无限等待

**详细任务**：
- 设置GPS定位超时为20秒
- 设置地址解析超时为10秒
- 使用 Promise.race 确保超时一定生效
- 超时后提供明确反馈和建议

**验证标准**：
- ✅ 20秒内一定完成或超时
- ✅ 超时错误清晰明确
- ✅ 超时后用户可以重试

---

## 阶段3：统一状态管理

### [ ] 任务6：检查useLocation使用情况
**优先级**：P1 (高)
**预估时间**：1小时
**描述**：检查项目中useLocation的所有使用点，消除冲突

**详细任务**：
- 搜索所有导入useLocation的文件
- 分析每个使用点的必要性
- 如果仅NativeMapView使用，考虑内联或移除
- 如果其他地方需要，确保不与地图定位冲突

**验证标准**：
- ✅ 所有useLocation使用点都清楚其作用
- ✅ 没有重复或冲突的定位逻辑

---

### [ ] 任务7：消除重复定位代码
**优先级**：P1 (高)
**预估时间**：2小时
**描述**：移除重复的定位逻辑，确保单一职责

**详细任务**：
- 如果useLocation不再需要，保留但标记为废弃
- 确保NativeMapView是唯一的地图定位入口
- 移除index.tsx中的冲突代码
- 确保状态流向清晰

**验证标准**：
- ✅ 定位逻辑只在一个地方
- ✅ 状态管理清晰，无冲突
- ✅ 代码无重复

---

## 阶段4：完善用户界面

### [ ] 任务8：改善状态显示和用户反馈
**优先级**：P1 (高)
**预估时间**：1.5小时
**描述**：优化UI，提供清晰的状态反馈和操作指导

**详细任务**：
- 优化状态文本，使其更友好
- 改进错误提示，提供具体解决建议
- 添加定位进度的视觉反馈
- 确保重试按钮醒目且有效

**文本优化示例**：
```typescript
const getStatusMessage = (loading, error, location) => {
  if (loading) return '📍 正在获取您的位置...';
  if (error) return error;
  if (location?.address) return `✅ ${location.address}`;
  return '';
};
```

**验证标准**：
- ✅ 状态文本清晰友好
- ✅ 错误提示有帮助性
- ✅ 用户知道下一步该做什么

---

### [ ] 任务9：实现手动选择位置功能
**优先级**：P2 (中)
**预估时间**：2小时
**描述**：定位失败时提供手动选择位置的备选方案

**详细任务**：
- 在错误提示中添加"手动选择位置"按钮
- 实现地图点击选择位置功能
- 选择后更新位置状态
- 提供"返回定位"选项

**验证标准**：
- ✅ 用户可以手动点击地图选择位置
- ✅ 手动选择的位置能正常使用
- ✅ 可以随时返回自动定位

---

## 阶段5：测试验证

### [ ] 任务10：功能测试和边界情况测试
**优先级**：P0 (必须)
**预估时间**：2小时
**描述**：全面测试定位功能的各种场景

**测试用例**：
1. **正常定位流程**
   - 首次启动应用
   - 定位成功并显示地址
   - 验证状态转换正确

2. **权限场景**
   - 首次授权定位
   - 拒绝授权
   - 取消授权

3. **网络和GPS场景**
   - 弱网络环境
   - GPS信号弱
   - 飞行模式

4. **错误处理场景**
   - GPS超时
   - 网络超时
   - API错误

5. **重试机制**
   - 第一次重试成功
   - 多次重试
   - 最终失败

**验证标准**：
- ✅ 所有测试用例通过
- ✅ 无崩溃或卡死
- ✅ 错误处理正确

---

### [ ] 任务11：在真机上验证修复效果
**优先级**：P0 (必须)
**预估时间**：1小时
**描述**：在安卓真机上实际测试验证

**详细任务**：
- 使用真实的安卓设备（不是模拟器）
- 测试WiFi和移动网络
- 测试室内和室外环境
- 测试弱GPS信号环境
- 验证重试和错误处理

**验证标准**：
- ✅ 真机上20秒内完成定位或显示错误
- ✅ 各种网络环境下都工作正常
- ✅ 重试机制有效

---

## 阶段6：文档和总结

### [ ] 任务12：更新文档和总结
**优先级**：P1 (高)
**预估时间**：1小时
**描述**：记录修复内容和更新相关文档

**详细任务**：
- 更新 LOCATION_FIX_SUMMARY.md
- 在 README.md 中添加定位问题说明
- 记录已知限制和最佳实践
- 总结修复内容和效果

**验证标准**：
- ✅ 文档记录完整准确
- ✅ 开发者能理解修复方案
- ✅ 用户知道如何使用

---

## 任务依赖关系

```
任务1 ←→ 任务2 (并行)
  ↓
任务3 (依赖任务1)
  ↓
任务4 (依赖任务3)
  ↓
任务5 (依赖任务4)
  ↓
任务6 ←→ 任务7 (并行，依赖任务1-5)
  ↓
任务8 ←→ 任务9 (并行，依赖任务3-7)
  ↓
任务10 (依赖任务3-9)
  ↓
任务11 (依赖任务10)
  ↓
任务12 (依赖任务11)
```

## 总体预估时间

- **总计**：约 15 小时
- **关键路径**：13 小时
- **可并行**：3 小时

## 风险和缓解

### 风险1：可能引入新问题
- **缓解**：每个任务完成后立即测试
- **回滚**：使用 Git 分支管理，可以随时回滚

### 风险2：影响iOS平台
- **缓解**：关键修改后同时在iOS上测试
- **注意**：不要修改iOS特有的逻辑

### 风险3：用户需要重新学习
- **缓解**：保持UI一致性，仅改善体验
- **说明**：提供更清晰的状态反馈

## 验收清单

修复完成后，需要满足以下所有条件：

### 功能验收
- [ ] 安卓设备上15-20秒内完成定位或显示明确错误
- [ ] 重试机制有效，最多3次重试
- [ ] 权限拒绝时有清晰引导和解决建议
- [ ] 网络错误时有明确反馈
- [ ] GPS不可用时有备选方案
- [ ] 所有状态转换正确，无卡住现象

### 代码质量验收
- [ ] 无TypeScript编译错误
- [ ] ESLint检查通过
- [ ] 代码有适当注释
- [ ] 无明显代码重复

### 用户体验验收
- [ ] 状态反馈清晰明确
- [ ] 错误信息有帮助性
- [ ] 重试操作简单直观
- [ ] 提供备选方案（手动选择位置）
- [ ] UI美观且一致

### 测试验收
- [ ] 所有测试用例通过
- [ ] 安卓真机测试通过
- [ ] iOS平台无回归问题
- [ ] 各种网络环境测试通过
- [ ] 边界情况测试通过

## 后续维护建议

1. **监控**：在用户反馈中关注定位相关问题
2. **优化**：根据用户使用情况进一步优化重试策略
3. **缓存**：考虑实现最后已知位置的缓存机制
4. **增强**：未来可考虑添加渐进式定位（先网络后GPS）

---

## 任务状态跟踪

| 任务 | 状态 | 开始时间 | 完成时间 | 备注 |
|------|------|----------|----------|------|
| 任务1 | ⏳ | | | |
| 任务2 | ⏳ | | | |
| 任务3 | ⏳ | | | |
| 任务4 | ⏳ | | | |
| 任务5 | ⏳ | | | |
| 任务6 | ⏳ | | | |
| 任务7 | ⏳ | | | |
| 任务8 | ⏳ | | | |
| 任务9 | ⏳ | | | |
| 任务10 | ⏳ | | | |
| 任务11 | ⏳ | | | |
| 任务12 | ⏳ | | | |

**状态说明**：
- ⏳ 待开始
- 🔄 进行中
- ✅ 已完成
- ⚠️ 阻塞中
- ❌ 失败
